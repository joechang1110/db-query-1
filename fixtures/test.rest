### Database Query Tool API Tests
### VS Code REST Client Extension Required
### https://marketplace.visualstudio.com/items?itemName=humao.rest-client

@baseUrl = http://localhost:8000/api/v1
@dbName = test-db
@dbName2 = test-postgres

### Variables (update these for your environment)
@postgresUrl = postgresql://postgres:postgres@localhost:5432/testdb
@mysqlUrl = mysql://root:password@localhost:3306/testdb
@sqliteUrl = sqlite:///./test.db

###
### Health Check
###
GET {{baseUrl}}/../health HTTP/1.1

###
### 1. List All Database Connections
### GET /dbs
###
GET {{baseUrl}}/dbs HTTP/1.1
Content-Type: application/json

###
### 2. Create PostgreSQL Database Connection
### PUT /dbs/{name}
###
PUT {{baseUrl}}/dbs/{{dbName}} HTTP/1.1
Content-Type: application/json

{
  "url": "{{postgresUrl}}",
  "description": "Test PostgreSQL database"
}

###
### 3. Create MySQL Database Connection
### PUT /dbs/{name}
###
PUT {{baseUrl}}/dbs/test-mysql HTTP/1.1
Content-Type: application/json

{
  "url": "{{mysqlUrl}}",
  "description": "Test MySQL database"
}

###
### 4. Create SQLite Database Connection
### PUT /dbs/{name}
###
PUT {{baseUrl}}/dbs/test-sqlite HTTP/1.1
Content-Type: application/json

{
  "url": "{{sqliteUrl}}",
  "description": "Test SQLite database"
}

###
### 5. Update Database Connection
### PUT /dbs/{name} (idempotent - updates if exists)
###
PUT {{baseUrl}}/dbs/{{dbName}} HTTP/1.1
Content-Type: application/json

{
  "url": "{{postgresUrl}}",
  "description": "Updated description for test database"
}

###
### 6. Get Database Metadata
### GET /dbs/{name}
### Returns cached metadata (tables, views, columns)
###
GET {{baseUrl}}/dbs/{{dbName}} HTTP/1.1
Content-Type: application/json

###
### 7. Refresh Database Metadata
### POST /dbs/{name}/refresh
### Forces a refresh of metadata by re-querying database
###
POST {{baseUrl}}/dbs/{{dbName}}/refresh HTTP/1.1
Content-Type: application/json

###
### 8. Execute SQL Query (SELECT only)
### POST /dbs/{name}/query
### Note: This endpoint may not be implemented yet (Phase 4)
###
POST {{baseUrl}}/dbs/{{dbName}}/query HTTP/1.1
Content-Type: application/json

{
  "sql": "SELECT * FROM users LIMIT 10"
}

###
### 9. Execute Complex SQL Query
### POST /dbs/{name}/query
###
POST {{baseUrl}}/dbs/{{dbName}}/query HTTP/1.1
Content-Type: application/json

{
  "sql": "SELECT u.name, COUNT(o.id) as order_count FROM users u LEFT JOIN orders o ON u.id = o.user_id GROUP BY u.name ORDER BY order_count DESC LIMIT 10"
}

###
### 10. Generate SQL from Natural Language (Chinese)
### POST /dbs/{name}/query/natural
### Note: This endpoint may not be implemented yet (Phase 5)
###
POST {{baseUrl}}/dbs/{{dbName}}/query/natural HTTP/1.1
Content-Type: application/json

{
  "prompt": "查询所有活跃用户的姓名和邮箱"
}

###
### 11. Generate SQL from Natural Language (English)
### POST /dbs/{name}/query/natural
###
POST {{baseUrl}}/dbs/{{dbName}}/query/natural HTTP/1.1
Content-Type: application/json

{
  "prompt": "Show all active users with their order counts, ordered by order count descending"
}

###
### 12. Get Query History
### GET /dbs/{name}/history
### Returns last 50 queries executed against this database
### Note: This endpoint may not be implemented yet (Phase 4)
###
GET {{baseUrl}}/dbs/{{dbName}}/history HTTP/1.1
Content-Type: application/json

###
### 13. Get Query History with Limit
### GET /dbs/{name}/history?limit=10
###
GET {{baseUrl}}/dbs/{{dbName}}/history?limit=10 HTTP/1.1
Content-Type: application/json

###
### 14. Delete Database Connection
### DELETE /dbs/{name}
###
DELETE {{baseUrl}}/dbs/{{dbName}} HTTP/1.1
Content-Type: application/json

###
### Error Test Cases
###

### 15. Invalid Database Name (special characters)
PUT {{baseUrl}}/dbs/invalid@name HTTP/1.1
Content-Type: application/json

{
  "url": "{{postgresUrl}}",
  "description": "This should fail"
}

### 16. Invalid Database URL
PUT {{baseUrl}}/dbs/invalid-url HTTP/1.1
Content-Type: application/json

{
  "url": "invalid://url",
  "description": "This should fail"
}

### 17. Get Non-existent Database
GET {{baseUrl}}/dbs/non-existent-db HTTP/1.1
Content-Type: application/json

### 18. Execute Invalid SQL (INSERT statement - should be rejected)
POST {{baseUrl}}/dbs/{{dbName}}/query HTTP/1.1
Content-Type: application/json

{
  "sql": "INSERT INTO users (name) VALUES ('test')"
}

### 19. Execute Invalid SQL (Multiple statements - should be rejected)
POST {{baseUrl}}/dbs/{{dbName}}/query HTTP/1.1
Content-Type: application/json

{
  "sql": "SELECT * FROM users; SELECT * FROM orders;"
}

### 20. Natural Language Query Too Short (should fail validation)
POST {{baseUrl}}/dbs/{{dbName}}/query/natural HTTP/1.1
Content-Type: application/json

{
  "prompt": "hi"
}

###
### Test Scenarios for Different Database Types
###

### 21. PostgreSQL Connection Test
PUT {{baseUrl}}/dbs/{{dbName2}} HTTP/1.1
Content-Type: application/json

{
  "url": "postgresql://postgres:postgres@localhost:5432/postgres",
  "description": "PostgreSQL test connection"
}

### 22. Get PostgreSQL Metadata
GET {{baseUrl}}/dbs/{{dbName2}} HTTP/1.1
Content-Type: application/json

### 23. Query PostgreSQL System Tables
POST {{baseUrl}}/dbs/{{dbName2}}/query HTTP/1.1
Content-Type: application/json

{
  "sql": "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' LIMIT 10"
}

###
### Batch Operations
###

### 24. List All Connections After Setup
GET {{baseUrl}}/dbs HTTP/1.1
Content-Type: application/json

### 25. Refresh All Database Metadata (manual - run for each DB)
POST {{baseUrl}}/dbs/{{dbName2}}/refresh HTTP/1.1
Content-Type: application/json

###
### Notes:
### 1. Update @postgresUrl, @mysqlUrl, @sqliteUrl variables at the top with your actual database URLs
### 2. Some endpoints (query, query/natural, history) may not be implemented yet depending on phase
### 3. Make sure backend server is running: make dev-backend or cd backend && uvicorn app.main:app --reload
### 4. Database connections are stored in SQLite at ./backend/db/db_query.db
### 5. OpenAI API key must be set in environment variable OPENAI_API_KEY for natural language queries

